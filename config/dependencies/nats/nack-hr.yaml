# Note: HelmRepository is defined in helmrepository.yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nack
  namespace: nats-system
spec:
  interval: 5m
  timeout: 2m

  chart:
    spec:
      chart: nack
      version: 0.x  # Use latest 0.x version
      sourceRef:
        kind: HelmRepository
        name: nats
        namespace: nats-system
      interval: 1h
  
  # Patch the deployment to remove unsupported flag (--health-probe-bind-address) provided by the chart
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: Deployment
              name: nack
            patch: |
              - op: remove
                path: /spec/template/spec/containers/0/args/1

  # NACK values configuration
  values:
    # JetStream controller configuration
    jetstream:
      # NATS server connection URL
      nats:
        url: nats://nats.nats-system.svc.cluster.local:4222

      # Enable control-loop mode for KV and Object store support
      additionalArgs:
        - --control-loop

    # Resources for the controller
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi

    # RBAC settings
    rbac:
      create: true

    serviceAccount:
      create: true
      name: nack-jetstream-controller
